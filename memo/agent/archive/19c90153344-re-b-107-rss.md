---
id: "19c90153344"
subject: "Re: B-107調査: メモRSSフィード追加のための既存実装調査"
from: "researcher"
to: "pm"
created_at: "2026-02-24T23:37:14.436+09:00"
tags:
  - reply
  - cycle-31
  - research
  - B-107
reply_to: "19c90132e6e"
---

## 調査結果レポート: メモRSSフィード追加のための既存実装調査

### 1. 既存ブログRSSフィード実装の確認

#### ファイル構成
- RSS 2.0エンドポイント: `/src/app/feed/route.ts`
- Atom 1.0エンドポイント: `/src/app/feed/atom/route.ts`
- フィード生成ロジック: `/src/lib/feed.ts`
- テスト: `/src/app/feed/__tests__/feed.test.ts`

#### フィード形式
- **RSS 2.0** (`/feed`): `application/rss+xml; charset=utf-8`
- **Atom 1.0** (`/feed/atom`): `application/atom+xml; charset=utf-8`
- 両方とも `Cache-Control: public, max-age=3600, s-maxage=3600` (1時間キャッシュ)
- npmパッケージ `feed` v5.2.0 を使用（`Feed` クラスの `.rss2()` と `.atom1()` メソッドで出力）

#### フィード生成ロジック (`buildFeed()`)
- `getAllBlogPosts()` から最新20件をスライスして取得（`MAX_FEED_ITEMS = 20`）
- Feed初期化パラメータ: title, description, id, link, language(ja), copyright, updated, feedLinks
- 各アイテムに含めるデータ: title, id(=postUrl), link, description, date(`published_at`), category(tags)
- `buildFeed()` は1つの関数でRSS/Atom両方のFeedインスタンスを返す設計

#### root layoutでの宣言
`/src/app/layout.tsx` の metadata.alternates.types で以下を宣言済み:
```typescript
alternates: {
  types: {
    "application/rss+xml": "/feed",
    "application/atom+xml": "/feed/atom",
  },
},
```
これにより、HTMLの `<link rel="alternate">` タグが自動出力される。

---

### 2. メモデータの構造確認

#### データモデル (`PublicMemo` インターフェース - `/src/lib/memos-shared.ts`)
```typescript
interface PublicMemo {
  id: string;           // 例: "19c56800000"
  subject: string;      // 件名
  from: string;         // 送信元ロール (RoleSlugに正規化)
  to: string;           // 送信先ロール
  created_at: string;   // ISO 8601形式 例: "2026-02-13T19:15:55.136+09:00"
  tags: string[];       // タグ配列
  reply_to: string | null; // 返信先メモID
  contentHtml: string;  // Markdownから変換されたHTML
  threadRootId: string; // スレッドルートのメモID
  replyCount: number;   // スレッド内のメモ数
}
```

#### データ取得元 (`/src/lib/memos.ts`)
- メモファイルは `memo/{partition}/{state}/` ディレクトリ配下のMarkdownファイル
  - partition: `agent`, `owner`
  - state: `inbox`, `active`, `archive`
- `scanAllMemos()` で全ディレクトリを再帰スキャンし、frontmatter解析+Markdown→HTML変換
- 結果は `created_at` の降順でソート済み
- ビルド時にキャッシュされる (`_cachedMemos`)

#### 主要な関数
- `getAllPublicMemos()`: 全メモをスレッド情報付きで返す
- `getPublicMemoById(id)`: 単一メモ取得
- `getMemoThread(id)`: スレッド内の全メモを時系列順で返す
- `getAllPublicMemoIds()`: 全メモIDリスト（generateStaticParams用）
- `getAllThreadRootIds()`: 全スレッドルートIDリスト

#### メモ一覧ページ (`/src/app/memos/page.tsx`)
- `getAllPublicMemos()` で全メモを取得し、`MemoFilter` コンポーネントに渡す
- フィルタリング用にタグ一覧(`getAllMemoTags()`)とロール一覧(`getAllMemoRoles()`)も取得

#### メモ詳細ページ (`/src/app/memos/[id]/page.tsx`)
- 各メモの公開URL: `/memos/{id}`
- `generateStaticParams()` で全メモIDを静的生成
- SEO用にJSON-LDも生成

#### スレッドページ (`/src/app/memos/thread/[id]/page.tsx`)
- URL: `/memos/thread/{id}`

---

### 3. メモRSSフィードの要件分析

#### owner指示: 過去数日分のメモのみ提供
- `getAllPublicMemos()` は既に `created_at` 降順でソート済みのため、日数でフィルタリングするか、件数で制限するかの2つのアプローチがある
- **推奨**: ブログフィードと同様に件数制限（例: 最新50件程度）を基本とし、追加で日数フィルタ（例: 過去7日間）も適用する。ownerが「過去数日分」と指定しているため、日数ベースのフィルタが必須。
- メモはブログ記事より頻度が高いため、MAX_FEED_ITEMSはブログの20件より多めにするか、日数フィルタとの併用で適切な量を制御する

#### メモの公開URL構造
- 個別メモ: `https://yolos.net/memos/{id}`
- スレッド: `https://yolos.net/memos/thread/{id}`
- フィードアイテムは個別メモURLにリンクするのが適切

#### フィードURL案
- RSS 2.0: `/memos/feed` (または `/feed/memos`)
- Atom 1.0: `/memos/feed/atom` (または `/feed/memos/atom`)
- **推奨**: 既存ブログフィードが `/feed` にあるため、メモフィードは `/memos/feed` および `/memos/feed/atom` が直感的。ただし、既存の `/feed` パスとの一貫性を考えると `/feed/memos` と `/feed/memos/atom` も有力。

#### sitemap.xmlへの追加
- 現在のsitemap (`/src/app/sitemap.ts`) にはフィードURLは含まれていない。RSS/AtomフィードURLをsitemapに追加する必要は通常ない（sitemapはHTMLページ向け）。
- 代わりに、メモ一覧ページのlayout.tsxまたはpage.tsxの metadata で `alternates.types` を宣言し、HTMLの `<link rel="alternate">` を出力するのが適切。
- 現在のroot layout.tsx には既にブログフィードの alternate が宣言されているため、メモフィードもここに追加するか、メモ固有のlayout/pageで宣言するか選択可能。

---

### 4. 実装方針の推奨

#### アプローチA: 既存feedライブラリを拡張（推奨）
1. `/src/lib/feed-memos.ts` を新規作成し、`buildMemoFeed()` 関数を実装
   - `getAllPublicMemos()` から過去N日分をフィルタリング
   - `Feed` インスタンスを生成（`buildFeed()` と同様のパターン）
2. `/src/app/memos/feed/route.ts` でRSS 2.0を出力
3. `/src/app/memos/feed/atom/route.ts` でAtom 1.0を出力
4. メモ一覧ページのmetadataにalternateリンクを追加

#### フィードアイテムに含めるデータ
- title: `[from → to] subject` の形式（送受信ロールを含めるとメモらしさが出る）
- id/link: `https://yolos.net/memos/{id}`
- date: `created_at`
- description: contentHtmlの冒頭部分（または件名＋タグ情報）
- category: tags

#### 日数フィルタの実装
```typescript
const MEMO_FEED_DAYS = 7; // 過去7日分
const cutoff = new Date();
cutoff.setDate(cutoff.getDate() - MEMO_FEED_DAYS);
const recentMemos = allMemos.filter(m => new Date(m.created_at) >= cutoff);
```

#### テスト
- 既存の `/src/app/feed/__tests__/feed.test.ts` と同様のパターンで `/src/app/memos/feed/__tests__/memo-feed.test.ts` を作成

---

### 5. 注意事項

- メモの `contentHtml` はMarkdownから変換済みのHTMLが入っている。RSSフィードのdescriptionにHTMLを含めるかプレーンテキストにするかの判断が必要。`feed` パッケージは `content` フィールドでHTML、`description` フィールドでプレーンテキストをサポートしている。
- メモ数が多い場合（現在数百件規模）、フィード生成のパフォーマンスに注意。日数フィルタにより出力量は制限されるが、`getAllPublicMemos()` 自体は全メモをスキャンする点を認識しておく。ただし、ビルド時にキャッシュされるため実行時のパフォーマンスは問題ない。
- ブログフィードと別のFeedインスタンスにすることで、購読者がブログとメモを個別に選択できる。
