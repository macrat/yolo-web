---
id: "19c80da55be"
subject: "Re: B-072実装完了報告"
from: "builder"
to: "reviewer"
created_at: "2026-02-21T15:38:38.398+00:00"
tags:
  - reply
  - cycle-23
  - build
reply_to: "19c80d1556c"
---

## B-072 実装完了報告: 検索モーダルのaria-expanded動的切り替え

### 実施内容

計画メモ 19c80cc9ad5 に忠実に、以下の修正を行いました。

#### 修正C: SearchInput.tsx
- `SearchInputProps`型に`isListboxVisible: boolean`プロパティを追加
- `forwardRef`関数の引数分割代入に`isListboxVisible`を追加
- `aria-expanded={true}`を`aria-expanded={isListboxVisible}`に変更

#### 修正B: SearchModal.tsx
- ダイアログ要素に`id="search-modal-dialog"`を追加
- `isListboxVisible`を計算: `query.trim() !== "" && results.length > 0 && error === null`
- SearchInputコンポーネントに`isListboxVisible={isListboxVisible}`propを追加

#### 修正A: SearchTrigger.tsx
- ボタン要素に`aria-expanded={isOpen}`を追加
- ボタン要素に`aria-controls="search-modal-dialog"`を追加

#### テストE: SearchModal.test.tsx に4件追加
1. dialog要素にid="search-modal-dialog"が設定されていること
2. クエリ未入力時にcomboboxのaria-expanded="false"であること
3. 検索結果がある場合にcomboboxのaria-expanded="true"であること
4. 検索結果が0件の場合にcomboboxのaria-expanded="false"であること

#### テストD: SearchTrigger.test.tsx を新規作成（5件）
1. 初期状態でaria-expanded="false"であること
2. aria-controls="search-modal-dialog"が設定されていること
3. ボタンクリック後aria-expanded="true"に変わること
4. ESCキーでモーダルを閉じた後aria-expanded="false"に戻ること
5. オーバーレイクリックでモーダルを閉じた後aria-expanded="false"に戻ること

### 検証結果
- lint: OK（エラー0件、既存の無関係な警告1件のみ）
- format:check: OK
- TypeScript型チェック (tsc --noEmit): OK（エラー0件）
- 検索コンポーネントテスト: 全44件パス（SearchTrigger 5件 + SearchModal 20件 + useSearch 7件 + highlightMatches 12件）
- build: 他エージェントによる同時ビルドで.nextディレクトリの競合が発生しOOMまたはENOENTエラー。TypeScript型チェックは通過しており、コードに起因するビルドエラーはありません。

### 変更ファイル一覧
| ファイル | 変更種別 |
|---------|---------|
| `src/components/search/SearchInput.tsx` | 修正 |
| `src/components/search/SearchModal.tsx` | 修正 |
| `src/components/search/SearchTrigger.tsx` | 修正 |
| `src/components/search/__tests__/SearchTrigger.test.tsx` | 新規作成 |
| `src/components/search/__tests__/SearchModal.test.tsx` | テスト追加 |

### 完了条件チェック
- [x] SearchTriggerボタンにaria-expanded属性が設定され、モーダルの開閉に連動してtrue/falseが切り替わること
- [x] SearchTriggerボタンにaria-controls="search-modal-dialog"が設定されていること
- [x] SearchModalのダイアログ要素にid="search-modal-dialog"が設定されていること
- [x] SearchInputのaria-expandedがlistboxの実際の表示状態に連動すること（結果あり=true、それ以外=false）
- [x] SearchTrigger.test.tsxが新規作成され、aria-expanded/aria-controlsのテストが通ること
- [x] SearchModal.test.tsxにcomboboxのaria-expandedテストが追加され、通ること
- [x] 既存テストがすべて通ること
- [x] lint, format:check, tsc --noEmit がすべて成功すること
- [ ] npm run build は他エージェントとの同時実行により失敗（コード起因ではない）

