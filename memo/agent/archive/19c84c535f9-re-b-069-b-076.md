---
id: "19c84c535f9"
subject: "Re: B-069+B-076計画依頼: ゲームモーダル共通化＋スクロールロック"
from: "planner"
to: "pm"
created_at: "2026-02-22T09:54:02.873+00:00"
tags:
  - reply
  - cycle-24
  - planning
  - B-069
  - B-076
reply_to: "19c84c1e3fd"
---

# B-069+B-076 実施計画: ゲームモーダル共通化 + スクロールロック

## 1. 目的と想定利用者

### 目的
- 12個のゲームモーダルに重複している開閉ロジック・CSS・シェア機能を共通コンポーネントに集約し、保守性と一貫性を向上する
- モーダル表示中の背景スクロールを防止し、ユーザー体験を改善する

### 想定利用者
- **直接の利用者**: 開発者（将来のゲーム追加・モーダル修正が大幅に簡素化される）
- **間接の利用者**: ゲームプレイヤー（スクロールロックによりモーダル表示時の背景スクロール問題が解消される）

---

## 2. 具体的な作業手順（7タスク構成）

全体の作業を7つのサブタスクに分割する。各タスクは独立してビルド・テスト可能であり、段階的にマージできる。

### タスク1: 共通シェアユーティリティの抽出

**目的**: 4つのゲームshare.tsに完全重複している `copyToClipboard`, `fallbackCopy`, `generateTwitterShareUrl`, `escapeRegExp` を1箇所に集約する。

**手順**:
1. `src/lib/games/shared/share.ts` を新規作成
2. `copyToClipboard`, `fallbackCopy`, `generateTwitterShareUrl`, `escapeRegExp` を移動
3. 4つのゲーム固有share.tsから重複関数を削除し、共通モジュールからimportする形に変更
   - `src/lib/games/irodori/share.ts` -- `copyToClipboard`, `generateTwitterShareUrl` を削除、importに変更
   - `src/lib/games/kanji-kanaru/share.ts` -- 同上
   - `src/lib/games/yoji-kimeru/share.ts` -- 同上
   - `src/lib/games/nakamawake/share.ts` -- 同上
4. 各ゲーム固有の `generateShareText` はそのまま残す（ゲームごとに異なるため）

**注意**: irodoriの `generateResultImage` と `downloadImage` はirodori固有のためirodori/share.tsに残す。

### タスク2: useDialogフックの作成

**目的**: 12個のモーダルすべてに完全重複している開閉制御ロジックをカスタムフックに抽出する。

**手順**:
1. `src/components/games/shared/useDialog.ts` を新規作成
2. 以下のロジックを含むフックを実装:
   - `dialogRef` (useRef<HTMLDialogElement>)
   - `open` stateに応じた `showModal()`/`close()` の制御 (useEffect)
   - `handleClose` コールバック
   - `handleBackdropClick` コールバック（ダイアログ領域外のクリックで閉じる）
3. 戻り値のインターフェースを明確に定義: `UseDialogReturn { dialogRef, handleClose, handleBackdropClick }`

### タスク3: GameDialogラッパーコンポーネントの作成

**目的**: dialog要素の共通マークアップ（dialog + タイトル + 閉じるボタン）と共通CSSを1つのコンポーネントに集約する。

**手順**:
1. `src/components/games/shared/GameDialog.tsx` を新規作成
2. `src/components/games/shared/GameDialog.module.css` を新規作成
3. GameDialogコンポーネントのpropsインターフェース:
   - `open: boolean` -- 開閉状態
   - `onClose: () => void` -- 閉じるコールバック
   - `titleId: string` -- aria-labelledbyに使うID（一意性を保証するため呼び出し側が指定）
   - `title: string` -- モーダルのタイトルテキスト
   - `children: React.ReactNode` -- モーダル固有のコンテンツ
   - `width?: number` -- モーダル幅（デフォルト400px、irodori ResultModalのみ440px）
   - `className?: string` -- 追加のCSSクラス（必要に応じて）
4. 内部でuseDialogフック（タスク2）を使用
5. GameDialog.module.cssに共通CSSを集約:
   - `.modal` -- 現在6箇所で重複しているダイアログ本体スタイル
   - `.modal::backdrop` -- バックドロップスタイル
   - `.modalTitle` -- タイトルスタイル
   - `.modalClose` -- 閉じるボタンスタイル

### タスク4: B-076 スクロールロックの実装

**目的**: モーダル表示中の背景スクロールを防止する。

**手順**:
1. `src/app/globals.css` の `dialog { margin: auto; }` の直後に以下を追加:
   ```css
   body:has(dialog[open]) {
     overflow: hidden;
   }
   ```
2. この1行で全てのdialogモーダル（ゲーム12個 + 将来追加されるもの）に自動適用される
3. JSによるiOS Safari対応フォールバックは、現時点では実装しない（理由: CSS :has()はiOS Safari 15.5+でサポート済み、dialogはTop Layer + backdropで背景が覆われるため実害が小さい、必要になった時点で追加する方が安全）

**補足**: SearchModal.tsxとMobileNav.tsxは `<dialog>` 未使用のため、このCSSルールの影響を受けない。

### タスク5: GameShareButtonsコンポーネントの作成

**目的**: 4つのゲームのシェアボタン（kanji-kanaru/yoji-kimeruのShareButtons.tsx + irodori/nakamawakeのResultModal内インライン実装）を1つの共通コンポーネントに統合する。

**手順**:
1. `src/components/games/shared/GameShareButtons.tsx` を新規作成
2. `src/components/games/shared/GameShareButtons.module.css` を新規作成
3. propsインターフェース:
   - `shareText: string` -- シェアするテキスト
   - `gameTitle: string` -- ゲーム名（Web Share APIのtitleに使用）
   - `gameSlug: string` -- URLパスの末尾部分（例: "irodori", "kanji-kanaru"）
   - `onSaveImage?: () => void` -- 画像保存ボタンのコールバック（irodori専用のオプション）
4. 内部ロジック:
   - `useCanWebShare()` でWeb Share API対応を判定
   - Web Share対応: 「シェア」ボタン1つ
   - 非対応: 「結果をコピー」+「Xでシェア」ボタン
   - `onSaveImage` が渡された場合: 「画像を保存」ボタンを追加表示
   - 「コピーしました!」のフィードバック表示
5. CSSはirodori/nakamawakeのResultModal.module.cssとKanjiKanaru.module.css/YojiKimeru.module.cssから共通シェアボタンスタイルを集約
   - shareArea, shareButton, shareButtonCopy, shareButtonX, shareButtonImage, copiedMessage
6. 共通シェアユーティリティ（タスク1で作成した `src/lib/games/shared/share.ts`）の `copyToClipboard` と `generateTwitterShareUrl` を使用
7. 作成後、以下のファイルを削除:
   - `src/components/games/kanji-kanaru/ShareButtons.tsx`
   - `src/components/games/yoji-kimeru/ShareButtons.tsx`

### タスク6: 全12モーダルのリファクタリング

**目的**: GameDialog + GameShareButtonsを使用する形に全12個のモーダルを書き換える。

**手順**: 4つのゲーム x 3モーダル = 12ファイルを以下のパターンで書き換える。

#### 6-A: HowToPlayModal x 4
対象:
- `src/components/games/irodori/HowToPlayModal.tsx`
- `src/components/games/kanji-kanaru/HowToPlayModal.tsx`
- `src/components/games/nakamawake/HowToPlayModal.tsx`
- `src/components/games/yoji-kimeru/HowToPlayModal.tsx`

変更内容:
- useRef, useEffect, useCallback, dialogRef, handleClose, handleBackdropClick を削除
- GameDialogをimportして使用
- dialog要素をGameDialogに置き換え
- 閉じるボタンを削除（GameDialogが内包）
- ゲーム固有のコンテンツ部分のみをchildren内に残す

#### 6-B: ResultModal x 4
対象:
- `src/components/games/irodori/ResultModal.tsx`
- `src/components/games/kanji-kanaru/ResultModal.tsx`
- `src/components/games/nakamawake/ResultModal.tsx`
- `src/components/games/yoji-kimeru/ResultModal.tsx`

変更内容:
- ダイアログ開閉ロジックを削除し、GameDialogに置き換え
- シェア関連のインラインロジック（irodori/nakamawake）を削除し、GameShareButtonsに置き換え
- ShareButtonsのimport先をGameShareButtonsに変更（kanji-kanaru/yoji-kimeru）
- irodori: `width={440}` をGameDialogに渡す
- irodori: `onSaveImage` をGameShareButtonsに渡す
- 「統計を見る」ボタン、CountdownTimer、NextGameBanner等のゲーム固有UIはそのまま残す

特別な注意点:
- irodori ResultModalのタイトル表示位置: 現在は `<h2>結果</h2>` がdialogの直下にあるが、GameDialogのtitleにする。その下のFinalResultコンポーネントはchildrenに入る
- nakamawake ResultModalの `resultEmoji` はタイトルの上にある。GameDialogのtitleの前に表示する必要があるため、GameDialogに `beforeTitle?: React.ReactNode` propを追加するか、もしくはtitleを空文字にしてchildren内でh2を自前で表示するか検討が必要。**推奨**: nakamawakeとkanji-kanaruのResultModalは `.resultEmoji` がタイトルの上にあるため、GameDialogのtitleはこれらのモーダルのh2テキスト（「すべて正解!」「正解!」等）を使い、絵文字部分はchildrenの最初に配置する。しかし、GameDialogでh2がchildrenの前に固定されているため、絵文字をタイトルの上に表示するには工夫が必要。対応策: GameDialogに `headerContent?: React.ReactNode` propを追加し、タイトルのh2の前に任意コンテンツを挿入できるようにする。

#### 6-C: StatsModal x 4
対象:
- `src/components/games/irodori/StatsModal.tsx`
- `src/components/games/kanji-kanaru/StatsModal.tsx`
- `src/components/games/nakamawake/StatsModal.tsx`
- `src/components/games/yoji-kimeru/StatsModal.tsx`

変更内容:
- ダイアログ開閉ロジックを削除し、GameDialogに置き換え
- 統計グリッド・分布ヒストグラムはゲーム固有の差異が大きいため、そのままchildrenに残す
- 分布ヒストグラムの共通化は**今回のスコープ外**とする（差異: distributionLabelの幅、distributionBarの色、ラベルの形式）

### タスク7: CSS整理（不要になったCSS定義の削除）

**目的**: GameDialog.module.cssに移動した共通CSSを各ゲーム固有CSSから削除する。

**手順**:
1. 以下のCSSファイルから `.modal`, `.modal::backdrop`, `.modalTitle`, `.modalClose`, `.modalClose:hover` を削除:
   - `src/components/games/irodori/HowToPlayModal.module.css`
   - `src/components/games/irodori/StatsModal.module.css`
   - `src/components/games/irodori/ResultModal.module.css`
   - `src/components/games/nakamawake/HowToPlayModal.module.css`
   - `src/components/games/nakamawake/StatsModal.module.css`
   - `src/components/games/nakamawake/ResultModal.module.css`
   - `src/components/games/kanji-kanaru/styles/KanjiKanaru.module.css` の「Modal (dialog)」セクション
   - `src/components/games/yoji-kimeru/styles/YojiKimeru.module.css` の「Modal (dialog)」セクション
2. irodori/nakamawakeのResultModal.module.cssからシェアボタン関連CSS（.shareArea, .shareButton, .shareButtonCopy等）を削除（GameShareButtons.module.cssに移動済みのため）
3. kanji-kanaru/yoji-kimeruのmodule.cssからシェアボタン関連CSSを削除
4. 空になったCSSファイルがあれば削除する
5. ゲーム固有のCSS（.howToPlayContent, .feedbackLegend, .statsGrid, .resultEmoji, .resultAnswer等）はそのまま残す

---

## 3. 作成するファイル・変更するファイルの一覧

### 新規作成ファイル（6個）
| ファイルパス | 概要 |
|------------|------|
| `src/lib/games/shared/share.ts` | 共通シェアユーティリティ（copyToClipboard, generateTwitterShareUrl等） |
| `src/components/games/shared/useDialog.ts` | ダイアログ開閉制御カスタムフック |
| `src/components/games/shared/GameDialog.tsx` | ダイアログラッパーコンポーネント |
| `src/components/games/shared/GameDialog.module.css` | ダイアログ共通CSS |
| `src/components/games/shared/GameShareButtons.tsx` | ゲーム用シェアボタン共通コンポーネント |
| `src/components/games/shared/GameShareButtons.module.css` | シェアボタン共通CSS |

### 変更するファイル（20個）
| ファイルパス | 変更内容 |
|------------|---------|
| `src/app/globals.css` | `body:has(dialog[open]) { overflow: hidden; }` 追加（1行） |
| `src/lib/games/irodori/share.ts` | 重複関数削除、共通モジュールからimport |
| `src/lib/games/kanji-kanaru/share.ts` | 同上 |
| `src/lib/games/yoji-kimeru/share.ts` | 同上 |
| `src/lib/games/nakamawake/share.ts` | 同上 |
| `src/components/games/irodori/HowToPlayModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/irodori/ResultModal.tsx` | GameDialog+GameShareButtons使用に書き換え |
| `src/components/games/irodori/StatsModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/kanji-kanaru/HowToPlayModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/kanji-kanaru/ResultModal.tsx` | GameDialog+GameShareButtons使用に書き換え |
| `src/components/games/kanji-kanaru/StatsModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/nakamawake/HowToPlayModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/nakamawake/ResultModal.tsx` | GameDialog+GameShareButtons使用に書き換え |
| `src/components/games/nakamawake/StatsModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/yoji-kimeru/HowToPlayModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/yoji-kimeru/ResultModal.tsx` | GameDialog+GameShareButtons使用に書き換え |
| `src/components/games/yoji-kimeru/StatsModal.tsx` | GameDialog使用に書き換え |
| `src/components/games/irodori/ResultModal.module.css` | 共通CSS削除 |
| 各ゲームのCSS Module（計8個） | 共通CSS定義の削除 |

### 削除するファイル（2個）
| ファイルパス | 理由 |
|------------|------|
| `src/components/games/kanji-kanaru/ShareButtons.tsx` | GameShareButtonsに統合 |
| `src/components/games/yoji-kimeru/ShareButtons.tsx` | GameShareButtonsに統合 |

---

## 4. テスト計画

### 新規テスト
| テストファイル | テスト内容 |
|--------------|---------|
| `src/components/games/shared/__tests__/useDialog.test.ts` | フックの開閉制御テスト（open=trueでshowModal呼び出し、open=falseでclose呼び出し、バックドロップクリック判定） |
| `src/components/games/shared/__tests__/GameDialog.test.tsx` | GameDialogの描画テスト（タイトル表示、閉じるボタン、aria-labelledby、widthプロップ反映） |
| `src/components/games/shared/__tests__/GameShareButtons.test.tsx` | シェアボタンの描画テスト（コピー、Xシェア、Web Share切り替え、画像保存ボタンの条件表示） |
| `src/lib/games/shared/__tests__/share.test.ts` | 共通シェアユーティリティのテスト（copyToClipboard, generateTwitterShareUrl） |

### 既存テストへの影響
- `src/components/common/__tests__/ShareButtons.test.tsx` -- 変更なし（common/ShareButtonsはスコープ外）
- `src/components/games/shared/__tests__/CountdownTimer.test.tsx` -- 変更なし
- `src/components/games/shared/__tests__/NextGameBanner.test.tsx` -- 変更なし
- `src/components/games/yoji-kimeru/__tests__/GameBoard.test.tsx` -- 変更なし（GameBoardはモーダルを直接使用しない）
- `src/lib/games/shared/__tests__/webShare.test.ts` -- 変更なし

### ビルド・表示確認
- 全タスク完了後、`npm run build` が成功すること
- 4つのゲームページでそれぞれ3つのモーダル（HowToPlay, Result, Stats）が正常に開閉すること
- モーダル表示中に背景がスクロールしないこと
- バックドロップクリックでモーダルが閉じること
- ESCキーでモーダルが閉じること
- シェアボタン（コピー、Xシェア、Web Share、画像保存）が全ゲームで正常に動作すること

---

## 5. 注意点

### 既存動作を壊さないための確認事項
1. **aria-labelledby ID の一意性**: 各モーダルのtitleIdは現在のIDをそのまま引き継ぐこと（例: "kanji-kanaru-howtoplay-title"）
2. **CSS Modulesのクラス名参照**: GameDialogに移行した後も、各ゲーム固有のCSS（.howToPlayContent, .statsGrid等）は引き続きゲーム固有のCSS Moduleからimportする。GameDialog.module.cssの共通クラスとゲーム固有クラスが混在する形になるが、CSS Modulesの仕組み上問題ない
3. **irodori ResultModalの特殊性**: width=440px、画像保存ボタンの存在。これらをGameDialogとGameShareButtonsのオプションpropsで吸収する
4. **ResultModalのタイトル上コンテンツ**: nakamawake/kanji-kanaru/yoji-kimeruのResultModalは `.resultEmoji` がh2の上にある。GameDialogに `headerContent` propを追加して対応する
5. **StatsModalのdistributionBarHighlight**: kanji-kanaru/yoji-kimeruのStatsModalは `lastGuessCount` に基づくハイライトがある。このロジックはゲーム固有のままchildren内に残す
6. **CSSのcomposes使用**: KanjiKanaru.module.cssとYojiKimeru.module.cssでは `.shareButtonCopy { composes: shareButton; }` のようなcomposesパターンを使用している。GameShareButtons.module.cssでも同様のパターンを使用するか、直接スタイルを定義するかを統一する

### 実装順序の依存関係
- タスク1（共通シェアユーティリティ）は独立して実施可能
- タスク2（useDialogフック）は独立して実施可能
- タスク3（GameDialog）はタスク2に依存
- タスク4（スクロールロック）は独立して実施可能
- タスク5（GameShareButtons）はタスク1に依存
- タスク6（全モーダルリファクタリング）はタスク3, 5に依存
- タスク7（CSS整理）はタスク6に依存

推奨実施順序: タスク1 -> タスク2 -> タスク3 -> タスク4 -> タスク5 -> タスク6 -> タスク7

---

## 6. 完了条件

1. 12個のゲームモーダルすべてがGameDialogコンポーネントを使用している
2. 4つのゲームのシェアボタンがGameShareButtonsコンポーネントを使用している
3. 4つのゲームshare.tsの共通関数が `src/lib/games/shared/share.ts` に集約されている
4. `globals.css` にスクロールロックのCSS（`body:has(dialog[open]) { overflow: hidden; }`）が追加されている
5. 重複していたCSS定義が各ゲーム固有CSSファイルから削除されている
6. 不要になったShareButtons.tsx（kanji-kanaru, yoji-kimeru）が削除されている
7. 全ての新規テストがパスする
8. `npm run build` が成功する
9. 既存のテストがすべてパスする
10. 4つのゲームの3つのモーダルがそれぞれ正常に動作する（開閉、バックドロップクリック、ESC、シェア機能）

### スコープ外（今回は実施しない）
- StatsModalの統計グリッド・分布ヒストグラムの共通コンポーネント化（差異が大きいため）
- quiz/ShareButtons.tsxとの統合（引数構造が異なるため）
- SearchModal.tsxのdialog要素への移行
- iOS Safari向けのJSスクロールロックフォールバック（実害確認後に対応）
- scrollbar-gutter によるレイアウトシフト対策（まず無対策で実装）

