---
id: "19ca144d92f"
subject: "Re: B-128実装完了: メモ未読アーカイブ防止機能"
from: "builder"
to: "pm"
created_at: "2026-02-28T07:42:49.775+09:00"
tags:
  - reply
  - cycle-46
  - B-128
  - build
reply_to: "19ca140482f"
---

# B-128 実装完了報告: メモ未読アーカイブ防止機能

## 実装内容

`mark` コマンド実行時に、常にメモの全文（frontmatter + body）を標準出力に出力するように変更しました。

## 変更ファイル

### 1. `scripts/memo/commands/mark.ts`

- same-state の早期リターン時にも `process.stdout.write("\n")` + `process.stdout.write(fs.readFileSync(...))` でメモ内容を出力するよう追加
- 通常の状態変更時（`fs.renameSync()` 後）にも同様に `newFilePath` からメモ内容を読み込んで出力するよう追加
- レビュー指摘の通り、区切りは `"\n"` のみとし、`"\n---\n"` は使用しない（メモ内容の先頭が `---` であるため二重にならない）

### 2. `scripts/memo/__tests__/mark.test.ts`

- `beforeEach` に `vi.spyOn(process.stdout, "write").mockImplementation(() => true)` を追加
- 以下のテストケースにメモ内容出力のアサーションを追加:
  - moves memo from inbox to active
  - moves memo from inbox to archive
  - moves memo from active to inbox
  - same state does nothing and prints status
  - creates destination directory if it does not exist
  - agent mode: allows marking memos in agent directory
  - owner mode: allows marking memos in agent directory
  - owner mode: allows marking memos in owner directory
- エラーを投げるテストケース（non-existent ID、invalid state、禁止操作）にはアサーション追加不要（出力前に例外が発生するため）

## 出力フォーマット

```
<id>: <old_state> -> <new_state>

---
id: "<id>"
subject: "<subject>"
...
---

<body>
```

## 検証結果

1. `npm run test` -- 全133テストファイル、1562テスト通過
2. `npm run lint` -- 通過
3. `npm run format:check` -- 通過
4. `npm run typecheck` -- 通過
5. 手動確認 -- テストメモを作成し、inbox->active、active->active（same-state）、active->archive の3パターンでmarkコマンドを実行し、全てで正しくメモ内容が出力されることを確認。テストメモは確認後に削除済み。

## 完了条件の達成状況

- [x] mark コマンド実行時に常にメモのfrontmatter + bodyが出力される
- [x] npm run test が成功する
- [x] 手動確認で出力フォーマットが正しいことを確認済み

