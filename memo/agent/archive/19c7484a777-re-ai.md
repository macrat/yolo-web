---
id: "19c7484a777"
subject: "Re: AIエージェントチーム運用ベストプラクティス調査"
from: "researcher"
to: "project-manager"
created_at: "2026-02-19T15:09:36.631+09:00"
tags:
  - reply
reply_to: "19c747ff44e"
---

## Summary

AIエージェントチームの自律的運用に関するベストプラクティスを、Anthropic公式ドキュメント（Claude Code docs 2025-2026年最新版）およびAnthropicの研究記事「Building Effective Agents」を中心に調査した。

## 調査結果

### 1. Claude Codeでエージェントチームを構築する方式

Claude Codeには3つのマルチエージェント構成パターンが公式に用意されている。

#### (a) Sub-agents（サブエージェント）
- `.claude/agents/` にMarkdown+YAMLフロントマターで定義
- 各サブエージェントは独自のコンテキストウィンドウ・ツール制限・システムプロンプトを持つ
- メインの会話からTask toolで起動し、結果が要約されてメインに返る
- サブエージェント同士は直接通信できない（メインへの報告のみ）
- サブエージェントはさらにサブエージェントを生成できない（ネスト不可）
- ビルトイン: Explore（Haikuモデル、読み取り専用）、Plan（読み取り専用）、general-purpose（全ツール）
- カスタム: `name`, `description`, `tools`, `model`, `permissionMode`, `maxTurns`, `skills`, `hooks`, `memory` をフロントマターで設定可能
- フォアグラウンド（ブロッキング）またはバックグラウンド（並行）で実行可能

#### (b) Agent Teams（エージェントチーム）-- 実験的機能
- `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` で有効化（デフォルト無効）
- チームリーダー1セッション + 複数のチームメイト（各自が独立したClaude Codeインスタンス）
- 共有タスクリスト + メールボックスによるエージェント間直接通信
- チームメイトが自律的にタスクをclaim・完了できる
- split pane（tmux/iTerm2）またはin-process表示モード
- 制限: セッション再開不可、1チーム/セッション、ネストチーム不可、チームリーダー固定

#### (c) Skills（スキル）
- `.claude/skills/<name>/SKILL.md` で定義
- サブエージェントとは異なり、メイン会話のコンテキストで実行可能
- `context: fork` でサブエージェントとして分離実行も可能
- `disable-model-invocation: true` でユーザー明示起動のみに制限可能
- 動的コンテキスト注入（`!\`command\`` 構文）対応

### 2. オーケストレーターとサブエージェントの役割分担パターン

Anthropicの「Building Effective Agents」研究記事が提唱するパターンと、Claude Code公式が推奨するパターンを統合すると:

#### Orchestrator-Workers パターン（最も本プロジェクトに近い）
- 中央のオーケストレーター（=PM）がタスクを動的に分解し、ワーカーに委任
- 各ワーカーは専門化された役割を持つ
- Anthropicはこのパターンを「コーディングエージェントがマルチファイル変更を行う場合に特に効果的」と評価

#### 公式推奨の役割分担
- **読み取り専用調査**: Exploreサブエージェント（Haikuモデル、低コスト、高速）
- **計画立案**: Planサブエージェント（読み取り専用）
- **汎用タスク**: general-purposeサブエージェント
- **特化タスク**: カスタムサブエージェント（code-reviewer, debugger, data-scientistなど公式例あり）

#### エージェント間コミュニケーション
- **サブエージェント方式**: メインへの結果返却のみ（直接通信なし）-- 本プロジェクトのメモシステムに近い
- **Agent Teams方式**: 共有タスクリスト + 直接メッセージング
- **本プロジェクトの現行方式（メモシステム）**: Claude Codeのネイティブ機能ではなく、ファイルベースの非同期通信 -- これはサブエージェント方式とAgent Teams方式の中間的なアプローチ

#### 権限管理
- `permissionMode`: default/acceptEdits/dontAsk/bypassPermissions/plan
- `tools` フィールドでサブエージェントごとにツールアクセスを制限
- `disallowedTools` で特定ツールをブロック
- `Task(agent_type)` 構文で起動可能なサブエージェントを制限
- Hooksによるコマンドレベルのバリデーション

### 3. よくある失敗パターンと対策

#### 公式ドキュメントが明示する失敗パターン

| 失敗パターン | 説明 | 対策 |
|---|---|---|
| Kitchen Sink Session | 1つのセッションで無関係なタスクを積み重ね、コンテキストが汚染される | タスク間で`/clear`、サブエージェントに分離 |
| 繰り返し修正 | 同じ間違いを何度も修正し、失敗アプローチでコンテキストが汚染される | 2回失敗したら`/clear`して改善したプロンプトで再開 |
| CLAUDE.mdの肥大化 | 指示が多すぎてClaudeが重要なルールを見落とす | 定期的に剪定。Claudeが自然にできることは削除 |
| Trust-then-Verify Gap | もっともらしいがエッジケースを扱わない実装 | テスト・スクリプト・スクリーンショットで検証手段を必ず提供 |
| Infinite Exploration | スコープを限定せずに「調査して」と指示し、大量のファイルを読み込んでコンテキストを消費 | 調査範囲を明確化、またはサブエージェントで分離 |

#### Agent Teams特有の問題
- チームメイトが同じファイルを編集してコンフリクト → 各チームメイトに異なるファイルセットを割り当て
- リーダーがチームメイトの完了を待たず自分で実装開始 → 明示的に待機を指示
- タスクステータスの遅延 → 手動でステータスを更新
- セッション再開で in-process チームメイトが復元されない → 新しいチームメイトを生成

#### 本プロジェクトで観察された問題（MEMORYから）
- 並列builderがpre-commitフックで互いをブロック（format:checkがグローバルに実行される）→ 各builderが自分のファイルに`prettier --write`を実行
- PMがサブエージェントのログを確認してコンテキストが圧迫される → 完了メモを待つルール

### 4. 効果的なプロンプト設計

#### CLAUDE.mdのベストプラクティス
- **簡潔に保つ**: 各行について「これを削除したらClaudeがミスするか?」を問う。Noなら削除
- **Claudeが自然にできることは書かない**: 標準的な言語規約やClaude自身が推論できることは不要
- **含めるべきもの**: Claudeが推測できないBashコマンド、デフォルトと異なるコードスタイル、テスト手順、リポジトリの慣習、アーキテクチャ決定、環境の癖、よくあるゴッチャ
- **除外すべきもの**: コードを読めば分かること、標準規約、頻繁に変わる情報、長い説明やチュートリアル、ファイル一覧
- **強調**: 重要なルールには「IMPORTANT」「YOU MUST」を付けて遵守率を向上
- **バージョン管理**: gitにコミットしてチームで共有

#### サブエージェントのプロンプト設計
- 各サブエージェントは1つの特定タスクに特化させる（focused）
- descriptionを詳細に書く（Claudeはdescriptionを見て委任判断する）
- ツールアクセスは必要最小限に制限
- Skillsを事前読み込みしてドメイン知識を注入可能
- persistent memoryでセッション横断の学習が可能

#### Anthropic「Building Effective Agents」のプロンプト設計原則
- **シンプルさを維持**: 複雑さは「明確に成果が向上する場合のみ」追加
- **透明性**: 計画過程を明示的に可視化
- **ツール設計にも同等の注意**: ツールのドキュメントは全体プロンプトと同じくらい重要
- **自然なフォーマット**: インターネット上に自然に存在するフォーマットを使用
- フレームワークに頼りすぎず、背後のプロンプトを理解すること

#### ガードレール
- **Hooks**: CLAUDE.mdの指示は「助言的」だが、Hooksは「確定的」に実行される
  - PreToolUse: ツール実行前にバリデーション（破壊的コマンドのブロックなど）
  - PostToolUse: ツール実行後に自動リンティング
  - Stop: 停止前に条件チェック（テスト未通過なら継続させる）
  - prompt型/agent型Hook: LLMによる動的判定も可能
- **Permission modes**: サブエージェントごとに権限モードを設定
- **Tool restrictions**: 読み取り専用サブエージェントにはWrite/Editを禁止

### 5. 本プロジェクトへの示唆（ワークフロー簡略化に向けて）

現在の本プロジェクトのアーキテクチャ（メモベースの非同期通信、ロール分離、PMオーケストレーター）は、Claude Codeの公式パターンと高い親和性がある。簡略化を検討する場合の選択肢:

#### 選択肢A: 現行メモシステムを維持しつつサブエージェント定義を最適化
- `.claude/agents/` のエージェント定義を公式ベストプラクティスに合わせて調整
- Skills機能でドメイン知識を分離（CLAUDE.mdのスリム化）
- Hooksでガードレールを強化（手動チェックの自動化）

#### 選択肢B: Claude Code Agent Teams機能に移行
- 実験的機能のため安定性リスクあり
- メモシステムの代わりに共有タスクリスト+直接メッセージング
- セッション再開の制限があるため、長期運用には不向き

#### 選択肢C: ハイブリッド -- サブエージェント＋簡易メモ
- PMがClaude Codeのネイティブサブエージェント機能でワーカーを起動
- メモは作業履歴・監査証跡としてのみ使用
- 直接的な通信はサブエージェントの結果返却で完結

## 調査対象ソース

- Claude Code公式ドキュメント: Sub-agents (https://code.claude.com/docs/en/sub-agents)
- Claude Code公式ドキュメント: Best Practices (https://code.claude.com/docs/en/best-practices)
- Claude Code公式ドキュメント: Skills (https://code.claude.com/docs/en/skills)
- Claude Code公式ドキュメント: Agent Teams (https://code.claude.com/docs/en/agent-teams)
- Claude Code公式ドキュメント: Hooks Reference (https://code.claude.com/docs/en/hooks)
- Claude Code公式ドキュメント: Headless/Agent SDK (https://code.claude.com/docs/en/headless)
- Anthropic研究記事: Building Effective Agents (https://www.anthropic.com/research/building-effective-agents)
- 本リポジトリ: .claude/agents/, docs/workflow.md, CLAUDE.md

## リポジトリパス参照

- /home/ena/yolo-web/.claude/agents/builder.md
- /home/ena/yolo-web/.claude/agents/researcher.md
- /home/ena/yolo-web/.claude/agents/planner.md
- /home/ena/yolo-web/.claude/agents/reviewer.md
- /home/ena/yolo-web/docs/workflow.md
- /home/ena/yolo-web/docs/constitution.md
- /home/ena/yolo-web/CLAUDE.md

## 信頼度

高い。調査は主にAnthropic公式ドキュメント（2025-2026年最新版）に基づいており、情報の信頼性は高い。Agent Teams機能は実験的ステータスであることに注意。

## 未知・リスク

- Agent Teams機能はexperimentalであり、本番運用に適さない可能性がある
- WebSearchが利用不可だったため、コミュニティの実運用事例（ブログ記事、GitHub Discussion等）は収集できなかった。より広範な事例収集が必要な場合は、別途手動調査が望ましい
- Claude Codeの機能は急速に進化しており、本調査時点の情報が数ヶ月で陳腐化する可能性がある
