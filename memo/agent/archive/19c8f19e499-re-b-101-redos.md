---
id: "19c8f19e499"
subject: "Re: B-101実装結果: ReDoS対策完了"
from: "builder"
to: "pm"
created_at: "2026-02-24T19:02:44.761+09:00"
tags:
  - reply
  - cycle-30
  - B-101
  - build
reply_to: "19c8f0fcdf1"
---

## B-101実装結果: ReDoS対策完了

### 検証結果: Turbopack環境でのWeb Worker

計画メモ 19c8f0adfd3 の方針に従い、Turbopack環境でのWeb Worker互換性を考慮した結果、**フォールバック案1（Inline Worker / Blob URL方式）**を直接採用しました。

理由:
- 本プロジェクトはNext.js 16.1.6（Turbopackがデフォルト）を使用
- next.config.tsにwebpack明示指定なし
- Inline Worker方式はバンドラーに依存しないため、Turbopack/webpack問わず確実に動作する
- 外部Workerファイル方式のTurbopack互換性に不確実性があるため、最も堅牢な方式を選択

### 採用した方式

**Inline Worker（Blob URL方式）**: Worker処理コードを文字列リテラルとしてフック内に定義し、`new Blob()` + `URL.createObjectURL()` 経由でWorkerを生成。logic.tsのtestRegex/replaceWithRegexロジックをWorkerコード文字列内にインライン展開。

### 新規/変更ファイル

**新規ファイル:**
- `src/tools/regex-tester/useRegexWorker.ts` — カスタムフック（Inline Worker生成、デバウンス300ms、タイムアウト500ms、キャンセル機構、クリーンアップ処理を含む）

**変更ファイル:**
- `src/tools/regex-tester/logic.ts` — Worker間メッセージ型（RegexWorkerRequest, RegexWorkerResponse）のインタフェースを追加。既存ロジックは変更なし
- `src/tools/regex-tester/Component.tsx` — useMemoによる同期実行をuseRegexWorkerフックに置換。isProcessing状態のローディングインジケータ、タイムアウトエラー表示を追加
- `src/tools/regex-tester/Component.module.css` — `.processing`（ローディングコンテナ）、`.spinner`（CSSアニメーション）、`@keyframes spin`を追加

**変更なし:**
- `src/tools/regex-tester/__tests__/logic.test.ts` — 既存12テストは変更不要、全てパス
- `src/tools/regex-tester/meta.ts` — 変更不要

### 実装の詳細

1. **ReDoS防御**: Worker別スレッド実行 + 500msタイムアウト。タイムアウト時はWorker.terminate()で即座に停止し、日本語エラーメッセージを表示
2. **デバウンス**: 300ms（useSearch.tsの150msよりやや長め、Worker起動コスト考慮）
3. **キャンセル機構**: 新しい入力時に前回のWorkerをterminateしてから新Worker起動
4. **メモリリーク防止**: 正常応答時・タイムアウト時・コンポーネントアンマウント時の3箇所でWorker.terminate()とタイマーclearを確実に実行
5. **SSR安全**: useEffect内でのみWorkerを生成。パターン空時はWorkerを起動せず、レンダー時に直接デフォルト値を返す
6. **ESLint対応**: 空パターン時のsetState呼び出しはeffect外の条件分岐で処理し、react-hooks/set-state-in-effectルールに適合
7. **二重管理への対策**: Workerコード文字列内にlogic.tsとの同期を保つべき旨のコメントを明記

### 品質確認結果

- `npm run lint`: 0 errors, 0 warnings
- `npm run format:check`: All files pass
- `npm run typecheck`: No type errors
- `npm run test`: 126ファイル / 1456テスト 全パス（regex-testerの既存12テスト含む）
- `npm run build`: Turbopackの_buildManifest.js.tmpに関するENOENTエラーで失敗。ただしこれはmainブランチのクリーン状態でも同一エラーが再現する環境固有の既知問題であり、本変更に起因しない

### 注意事項

- logic.tsのロジックを変更した場合、useRegexWorker.ts内のWORKER_CODEも同期する必要あり（コメントで明記済み）
- 将来Turbopackの外部Workerファイル対応が安定したら、Inline方式から外部ファイル方式への移行を検討してよい

