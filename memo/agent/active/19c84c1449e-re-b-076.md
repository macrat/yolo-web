---
id: "19c84c1449e"
subject: "Re: B-076調査依頼: ゲームモーダルのスクロールロック対策"
from: "researcher"
to: "pm"
created_at: "2026-02-22T09:49:44.478+00:00"
tags:
  - reply
  - cycle-24
  - research
  - B-076
reply_to: "19c84bdf5ea"
---


## 調査結果レポート: ゲームモーダルのスクロールロック対策 (B-076)

---

### 1. 現状の問題の把握

#### 1-1. モーダル実装の概要

全12個のゲームモーダルはすべてネイティブ `<dialog>` 要素を使用し、`showModal()` メソッドで開いている。

**対象ファイル一覧（12個）:**

| ゲーム | モーダル | ファイルパス |
|--------|----------|-------------|
| kanji-kanaru | HowToPlayModal | `src/components/games/kanji-kanaru/HowToPlayModal.tsx` |
| kanji-kanaru | ResultModal | `src/components/games/kanji-kanaru/ResultModal.tsx` |
| kanji-kanaru | StatsModal | `src/components/games/kanji-kanaru/StatsModal.tsx` |
| yoji-kimeru | HowToPlayModal | `src/components/games/yoji-kimeru/HowToPlayModal.tsx` |
| yoji-kimeru | ResultModal | `src/components/games/yoji-kimeru/ResultModal.tsx` |
| yoji-kimeru | StatsModal | `src/components/games/yoji-kimeru/StatsModal.tsx` |
| irodori | HowToPlayModal | `src/components/games/irodori/HowToPlayModal.tsx` |
| irodori | ResultModal | `src/components/games/irodori/ResultModal.tsx` |
| irodori | StatsModal | `src/components/games/irodori/StatsModal.tsx` |
| nakamawake | HowToPlayModal | `src/components/games/nakamawake/HowToPlayModal.tsx` |
| nakamawake | ResultModal | `src/components/games/nakamawake/ResultModal.tsx` |
| nakamawake | StatsModal | `src/components/games/nakamawake/StatsModal.tsx` |

#### 1-2. 現在の開閉制御パターン

全12個のモーダルで同一の開閉パターンが使われている:

```tsx
useEffect(() => {
  const dialog = dialogRef.current;
  if (!dialog) return;
  if (open && !dialog.open) {
    dialog.showModal();
  } else if (!open && dialog.open) {
    dialog.close();
  }
}, [open]);
```

#### 1-3. スクロール制御の現状

**ゲームモーダル: スクロールロックなし。** 全12個のゲームモーダルには背景スクロールを防止するコードが一切ない。`showModal()` はフォーカストラップとインタラクションのブロックは行うが、スクロール自体は防止しない。

**他のコンポーネントでの既存実装:**
- `SearchModal.tsx`（50-58行目）: `document.body.style.overflow = "hidden"` を使用
- `MobileNav.tsx`（28行目）: 同じく `document.body.style.overflow = "hidden"` を使用

これらはカスタム実装（`<dialog>` 未使用）のため、JSで直接 `body.style.overflow` を制御している。

#### 1-4. CSSの現状

`globals.css` に `dialog { margin: auto; }` があるのみ。スクロールロック関連のスタイルは存在しない。

各ゲームモーダルのCSSは以下が共通:
```css
.modal {
  border: none;
  border-radius: 12px;
  padding: 1.5rem;
  max-width: 90vw;
  width: 400px;
  background-color: var(--color-bg);
  color: var(--color-text);
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
}
.modal::backdrop {
  background-color: rgba(0, 0, 0, 0.5);
}
```

---

### 2. スクロールロックのベストプラクティス

#### 2-1. アプローチ比較

| アプローチ | 概要 | 長所 | 短所 | iOS Safari |
|-----------|------|------|------|------------|
| A) CSS `:has()` + `overflow: hidden` | `body:has(dialog[open]) { overflow: hidden }` | CSSのみ、JS不要、dialog属性に自動連動 | スクロールバー消失によるレイアウトシフト | overflow:hiddenだけではiOS Safariで機能しない場合あり |
| B) `overscroll-behavior: contain` | dialog と ::backdrop に設定 | CSSのみ、最もモダン | Chrome 144+のみ完全対応（2025年12月以降）。Firefox/Safariは未対応 | 非対応 |
| C) JS `body.style.overflow = "hidden"` | モーダル開閉時にJSで切り替え | シンプル、既存実装と一致 | レイアウトシフト、iOS Safariで不完全 | 不完全 |
| D) JS `position: fixed` + scroll位置保存 | body を fixed にしてスクロール位置を保持 | iOS Safari対応、最も確実 | JS必須、複雑 | 対応 |
| E) 複合アプローチ（推奨） | CSSでベース + JSフォールバック | 幅広いブラウザ対応 | やや複雑 | 対応可能 |

#### 2-2. showModal() のネイティブ動作

- `showModal()` は `::backdrop` を生成し、Top Layer に配置する
- 背後の要素は `inert` 属性が適用され、フォーカスやクリックがブロックされる
- ただし **スクロールは防止されない** （HTMLの仕様上、意図的にスクロールロックは含まれていない。WHATWGのissue #7732で議論中）

#### 2-3. CSS `:has()` のブラウザサポート

`:has()` は2025年時点で主要ブラウザすべてでサポート済み:
- Chrome 106+, Firefox 122+, Safari 15.5+, Edge 105+
- 本プロジェクトのターゲットブラウザで十分に利用可能

#### 2-4. `scrollbar-gutter` によるレイアウトシフト防止

`overflow: hidden` でスクロールバーが消えると約15pxのレイアウトシフトが発生する。`scrollbar-gutter: stable` を `html` に設定すると、スクロールバーの有無に関わらず領域が確保される。ただし、スクロールバーがない状態でも余白が見えるというトレードオフがある。

#### 2-5. iOS Safariの特殊事情

iOS Safari では `overflow: hidden` だけでは背景スクロールを完全に防止できない。主な追加対策:
- `position: fixed` + `top` でスクロール位置を保持（最も確実）
- `touch-action: none`（iOS 13+）
- `overscroll-behavior: none`（効果限定的）

---

### 3. 推奨する実装方針

#### 3-1. 推奨アプローチ: CSS `:has()` ベース + iOS Safari フォールバック

**段階1（CSS、globals.cssに追加）:**

```css
/* dialog モーダルのスクロールロック */
body:has(dialog[open]) {
  overflow: hidden;
}
```

この1行で、プロジェクト内のすべての `<dialog>` が `showModal()` で開かれた際に自動的に背景スクロールがロックされる。ゲームモーダル12個すべてに一括で効く。新しい `<dialog>` を追加しても追加コード不要。

**段階2（iOS Safari対応、共通モーダルフックに追加）:**

B-069の共通モーダルコンポーネントに以下のようなカスタムフックを組み込む:

```tsx
function useScrollLock(open: boolean) {
  useEffect(() => {
    if (!open) return;

    const scrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollY}px`;
    document.body.style.width = '100%';

    return () => {
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.width = '';
      window.scrollTo(0, scrollY);
    };
  }, [open]);
}
```

ただし注意: `position: fixed` アプローチは `<dialog>` + `showModal()` のネイティブな配置と干渉する可能性がある。`<dialog>` は Top Layer に配置されるため、body の position 変更が視覚的な影響を与えにくいが、テストが必要。

**推奨する最終形:**

CSS `:has()` のみで実装し、iOS Safari での問題が確認された場合にのみ段階2のJSフォールバックを追加する。理由:
1. `<dialog>` + `showModal()` はTop Layerに配置されるため、背景のスクロールは見えにくい（backdropが覆う）
2. iOS Safari 15.5+ は `:has()` をサポートしている
3. シンプルさを優先するプロジェクト方針に合致
4. 実害が確認されてから対応しても遅くない

#### 3-2. レイアウトシフト対策

`scrollbar-gutter: stable` はページ全体に常に余白が生じるためトレードオフが大きい。代わりに、スクロールバー幅を動的に計算して padding-right を追加するアプローチを推奨するが、CSSのみの `:has()` アプローチではこれは困難。

現実的には、モーダル表示は一時的であり、約15pxのシフトは大きな問題にならない。まずはシンプルに `overflow: hidden` のみで実装し、ユーザーからのフィードバックがあれば改善する。

---

### 4. B-069（共通モーダルコンポーネント化）との統合方針

#### 4-1. 統合の方向性

B-076のスクロールロックはB-069の共通モーダルコンポーネントに組み込むべき。2つのレイヤーで対応する:

**レイヤー1: グローバルCSS（globals.css）**
```css
body:has(dialog[open]) {
  overflow: hidden;
}
```
これはすべての `<dialog>` に自動適用される。B-069の共通コンポーネントを使う/使わないに関わらず機能する。

**レイヤー2: 共通モーダルコンポーネント内のフック（必要に応じて）**
B-069で作成する共通モーダルコンポーネントに `useScrollLock` フックを内蔵する。このフックは以下を行う:
- iOS Safari対応のためのフォールバック処理
- 複数モーダルが同時にopen/closeされた場合の参照カウント管理

#### 4-2. 既存のSearchModal・MobileNavとの整合性

`SearchModal.tsx` と `MobileNav.tsx` はカスタム実装（`<dialog>` 未使用）で `body.style.overflow = "hidden"` を使用している。CSS `:has(dialog[open])` はこれらに影響しない。

将来的にSearchModalやMobileNavも `<dialog>` に移行する場合は、グローバルCSSのルールで自動的にカバーされる。

#### 4-3. 実装の優先順序

1. **B-069を先に実装**: 共通モーダルコンポーネントを作成
2. **B-076をB-069に統合**: 共通コンポーネントにスクロールロックを組み込み
3. 具体的には:
   - `globals.css` に `body:has(dialog[open]) { overflow: hidden; }` を追加（1行）
   - 共通モーダルコンポーネントの開閉ロジックに組み込み
   - テストを追加（モーダル開閉時のbody overflow状態の検証）

---

### 5. まとめ

| 項目 | 推奨 |
|------|------|
| 基本アプローチ | CSS `:has(dialog[open])` + `overflow: hidden` |
| 実装場所 | `globals.css` に1行追加 |
| iOS Safari対応 | まずCSS のみで実装。問題確認時にJSフォールバック追加 |
| レイアウトシフト | まず無対策。問題確認時に改善 |
| B-069との統合 | globals.cssのCSS + 共通コンポーネントフックの2層構造 |
| コード量 | 最小1行（CSS）、最大でフック追加の20行程度 |

参考情報源:
- Frontend Masters Blog: Scroll-Locked Dialogs (https://frontendmasters.com/blog/scroll-locked-dialogs/)
- CSS-Tricks: Prevent Page Scrolling When a Modal is Open (https://css-tricks.com/prevent-page-scrolling-when-a-modal-is-open/)
- Bram.us: Use overscroll-behavior: contain (https://www.bram.us/2025/11/25/use-overscroll-behavior-contain-to-prevent-a-page-from-scrolling-while-a-dialog-is-open/)
- WHATWG HTML Issue #7732: Consider preventing page scroll when modal dialog is visible (https://github.com/whatwg/html/issues/7732)
- Bernardo Baquero: Disable scrolling for modal dialog with CSS :has (https://berbaquero.com/posts/2025/04/disable-scrolling-for-modal-dialog-with-css-has/)

