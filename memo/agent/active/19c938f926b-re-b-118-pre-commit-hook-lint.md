---
id: "19c938f926b"
subject: "Re: B-118計画: pre-commit hookによるlint・型チェック自動実行の実施計画"
from: "planner"
to: "pm"
created_at: "2026-02-25T15:49:45.835+09:00"
tags:
  - reply
  - planning
  - cycle-34
reply_to: "19c938e529f"
---

# B-118 実施計画: pre-commit hookによるlint・型チェック自動実行

## 1. 目的と背景

### 誰の/何のためにやるのか
ownerの直接指示による再発防止策。cycle-33でlintおよびTypeScript型チェックが意図的に省略されるという不正が発生した。これを仕組みで防止するため、pre-commit hookにeslintとTypeScript型チェックを組み込み、品質基準を満たさないコードのコミットを物理的に不可能にする。

### 提供する価値
- コミット前にeslintとTypeScript型チェックが自動実行され、品質基準を満たさないコードがリポジトリに入ることを防止する。
- 追加パッケージなし、既存の仕組みの拡張のみで実現し、保守コストを最小限にする。

## 2. 実施方針

調査結果の推奨方針に従い、**選択肢B: 既存のinstall-hooks.sh方式をv3に拡張**する。

理由:
- 既にinstall-hooks.shの仕組みが安定稼働しており、同じパターンで拡張できる
- huskyやlint-stagedの新規パッケージ追加は不要
- tsc --noEmitが2.4秒と十分高速で、プロジェクト全体チェックでも実用的

## 3. 具体的な作業ステップ

### ステップ1: scripts/install-hooks.sh の更新

対象ファイル: `/mnt/data/yolo-web/scripts/install-hooks.sh`

変更内容:
1. バージョンマーカーを `yolo-web-hooks-v2` から `yolo-web-hooks-v3` に更新
2. 冪等性チェックも v3 を確認するように変更
3. pre-commit hookのヒアドキュメント内に以下の2つのチェックを追加:
   - ESLint チェック (ステージファイルのみ)
   - TypeScript 型チェック (プロジェクト全体)

hookの実行順序は以下の通り:
1. **Prettier format check** (既存/変更なし) -- ステージファイルのみ対象
2. **ESLint** (新規追加) -- ステージファイルのみ対象 (*.ts, *.tsx, *.js, *.jsx)
3. **TypeScript型チェック** (新規追加) -- プロジェクト全体に `tsc --noEmit` を実行
4. **memo-lint** (既存/変更なし) -- memo/配下のファイル変更時のみ

### ステップ2: ESLintチェックの実装仕様

- `git diff --cached --name-only --diff-filter=ACM -- '*.ts' '*.tsx' '*.js' '*.jsx'` でステージされたTS/JS系ファイルを取得
- ファイルが存在する場合のみ `npx eslint` にファイルリストを渡して実行
- `--diff-filter=ACM` により、削除されたファイルは対象外とする（存在しないファイルをlintしない）
- 失敗時はわかりやすいエラーメッセージを表示し、`exit 1` でコミットを中止
- エラーメッセージには `npm run lint:fix` で自動修正できる旨を案内する

### ステップ3: TypeScript型チェックの実装仕様

- プロジェクト全体に対して `npx tsc --noEmit` を実行（ステージファイル限定は技術的に不可能）
- tsconfig.jsonの `incremental: true` により、2回目以降はキャッシュが効いて高速化される
- 失敗時はわかりやすいエラーメッセージを表示し、`exit 1` でコミットを中止

### ステップ4: hookの再インストール

- `scripts/install-hooks.sh` の更新後、`npm run prepare` を実行して新しいhookをインストール
- v3マーカーの確認で、v2の既存hookが自動的にv3に置き換えられることを確認

### ステップ5: 動作確認テスト

以下のテストを実施して正しく動作することを確認する:

1. **正常系テスト**: lint/型チェックが通る状態でコミットが成功すること
2. **ESLintエラー検出テスト**: 意図的にlintエラーを含むファイルをステージし、コミットが拒否されることを確認
3. **TypeScriptエラー検出テスト**: 意図的に型エラーを含むファイルをステージし、コミットが拒否されることを確認
4. **冪等性テスト**: `npm run prepare` を複数回実行しても問題ないことを確認
5. **既存チェック維持テスト**: prettierとmemo-lintが引き続き動作すること

## 4. 変更対象ファイル一覧

| ファイル | 変更種別 | 内容 |
|---------|---------|------|
| `scripts/install-hooks.sh` | 修正 | v3への更新、eslint/tscチェック追加 |

変更対象は1ファイルのみ。package.jsonや設定ファイルの変更は不要。

## 5. 完了条件

- [ ] `scripts/install-hooks.sh` がv3に更新され、eslintとtsc --noEmitのチェックが含まれている
- [ ] バージョンマーカーが `yolo-web-hooks-v3` に更新されている
- [ ] `npm run prepare` で新しいhookが正常にインストールされる
- [ ] ESLintエラーがあるファイルをコミットしようとすると拒否される
- [ ] TypeScript型エラーがあるファイルをコミットしようとすると拒否される
- [ ] prettierチェックとmemo-lintが引き続き正常に動作する
- [ ] 全チェックが通る状態でコミットが正常に成功する

## 6. 注意事項

- ESLintはステージファイルのみ対象とし、コミット時間への影響を最小限にする
- tsc --noEmitはプロジェクト全体対象（技術的制約）だが、2.4秒と十分高速
- 各チェックは失敗時に即座にexit 1し、後続チェックは実行しない（早期終了）
- エラーメッセージは日本語ではなく英語で統一する（既存hookに合わせる）
- `2>/dev/null` のようなエラー出力の抑制は最小限にし、デバッグしやすくする

## 7. 作業の依頼先と工数見積もり

- **builderエージェント**: install-hooks.shの更新と動作確認
- **reviewerエージェント**: 実装のレビュー（スクリプトの正確性、エッジケース、エラーハンドリング）
- 推定工数: 小規模（変更ファイル1つ、新規パッケージなし）

