# ワークフロー

## ロールと責任

本プロジェクトでは以下のロールが定義されています。メモやドキュメントではこの正確なロール名を使用してください。

### owner

- **責任**: Constitutionの策定、`project manager`の監視、必要に応じた指示
- Constitutionは不変であり、すべてのロールが準拠する義務がある

### project manager

- **責任**: PVを増加させるための指示と意思決定
- バックログの維持（`docs/backlog.md` の直接編集が許可されている）、タスクのメモによる委任
- `reviewer`の結果とConstitution準拠に基づく成果物の受理/拒否
- `main`へのプッシュによるリリース判断
- リポジトリが実験を継続できる状態の維持

> **ルール**: `project manager` は実作業を直接行ってはならない。実作業には以下が含まれる:
>
> - コード編集、ファイル作成、ビルド実行
> - リポジトリやコードベースの調査・分析（→ `researcher` に委任すること）
> - 詳細な技術仕様や実装計画の策定（→ `planner` に委任すること）
> - Task tool / Explore agent / Bash agent を使った直接的な情報収集
>
> すべての実作業は適切なエージェントロールに委譲すること。`project manager` の責務は以下に限定される：
>
> - メモの確認とトリアージ
> - 優先順位付けと戦略的判断
> - メモの作成・送信による作業委譲
> - 進捗監視とエージェント間の調整
> - `reviewer` の起動とレビュー依頼の処理開始はPMの責務
> - サブエージェント起動後、完了報告メモが届くまでサブエージェントのログや途中出力を確認してはならない（メインエージェントのコンテキスト圧迫防止）
>
> PMが委任メモに記載してよいのは「何を達成すべきか」（ゴール・要件・受入基準）のみであり、「どう実現するか」（技術選定・実装方法・ファイル構成）は含めてはならない。

### researcher

- **責任**: 正確で関連性のある情報の提供
- リポジトリおよび（必要に応じて）インターネットの調査
- 未知のリスクの特定（調査・特定までで、実装やプランの策定、判断は一切行わない）
- 調査結果は依頼者への返信メモで提供し、PMにはメモIDだけを伝える（依頼者がPMでない場合はPM宛てのメモは書かない）

### planner

- **責任**: 信頼性のある計画の提供
- ゴールからステップバイステップの計画と受入基準への変換
- 複雑な調査が必要な場合はresearcherに調査を依頼
- 作成したプランはメモに詳細をまとめてreviewrに送信し、承認されるまで必要に応じて修正
- 計画が承認されたらPMに承認された計画のメモIDを伝えるためのメモを送信

### builder

- **責任**: 指示された通りに正確に実装する
- メモで提供された計画/タスクの実装
- 変更範囲をメモの受入基準に限定
- 作業完了後、reviewerにレビュー依頼のメモを送信し、承認されるまで必要に応じて修正
- レビューが承認されたら、PMに完了報告のメモを送信する
- 完了報告には、作業の途中で見つけた問題点やリスク、今後の改善点などを含めてもよい

> **ルール（完了報告前の必須チェック）**: `builder` は完了報告メモを送信する前に、必ず以下の全チェックをローカルで実行し、すべてパスすることを確認しなければならない。これらのチェックの結果を完了報告メモに含めること。
>
> ```bash
> npm run typecheck
> npm run lint
> npm run format:check
> npm test
> npm run build
> ```

### reviewer

- **責任**: すべての問題を発見する
- 正確性、明確性、保守性、運用一貫性、Constitution準拠のレビュー
- 承認、変更要求、または拒否を具体的かつテスト可能なフィードバックとともに返信
- レビューの結果は依頼者への返信メモで提供し、PMにはメモIDだけを伝える（依頼者がPMでない場合はPM宛てのメモは書かない）

### process engineer

**_このロールは廃止とする。_**
担当していた作業は、researcherとplannerがそれぞれの責任の範囲内で引き継ぐ。

- **責任**: 他のエージェントが効率的に状態を生成できるよう支援する
- ワークフローメカニクスの改善（メモ仕様、テンプレート、ディレクトリ構造、規約）
- アーカイブされたメモの分析とプロセス改善の提案

## メモルーティングルール

詳細は `docs/memo-spec.md` を参照。

- すべてのメモ操作は必ずメモCLIツール（`npm run memo`）を使用すること。`memo/` ディレクトリを直接操作（ファイルの作成、移動、編集、削除）することは禁止する
- メモはすべて `memo/` 配下に、受信者ロールごとにパーティション化
- メモを送信するには、対象ロールの `inbox/` にファイルを作成
- 各ロールのディレクトリには3つのサブディレクトリがある:
  - `inbox/` — 未読メッセージ（キュー）
  - `active/` — 作業中タスク（ToDoリスト）
  - `archive/` — 完了済み（履歴）

### メモのトリアージルール

- エージェントは作業開始時に `inbox/` と `active/` の両方を確認すること
- `inbox/` のメモは読んだら即座にトリアージする:
  - 単発の情報提供や返信 → そのまま `archive/` へ
  - 継続的なタスク → `active/` へ移動
- `active/` のメモはタスク完了時に `archive/` へ移動
- エージェントは作業終了前にすべての `inbox/` メモをトリアージしなければならない
- 返信は新しいメモファイルとして作成し、`reply_to` で元メモの `id` を参照する
- あるエージェントからの依頼を終えて別のエージェントに引き継ぐ場合でも、 `reply_to` を使って元の依頼メモを参照する

### inbox操作の権限ルール

- 各ロールのinbox/のメモをトリアージ（archive/やactive/への移動）できるのは、そのロール自身のみである
- 他ロールのinbox/にメモを追加すること（送信）は全ロールに許可される
- 他ロールのinbox/からメモを移動・削除することは禁止する
- 他ロールのinbox/にメモが滞留している場合、PMはそのロールにトリアージを依頼するメモを送信すること

### メモの粒度ルール

1メモには1タスクのみを含めること。詳細は `docs/memo-spec.md`「メモの粒度ルール」を参照。

## 標準ライフサイクルパターン

```
research → plan → review plan → build → review implementation → ship
```

1. **Research**: `project manager` が `researcher` に調査を依頼
2. **Plan**: `project manager` が `planner` に計画を依頼（researcherの調査結果を参照）
3. **Review plan**: `planner` が `reviewer` にレビューを依頼し、受け入れられるまで繰り返し修正する
4. **Build**: `project manager` が `builder` に実装を依頼（承認された計画のmemo IDを参照）
5. **Review implementation**: `builder` が `reviewer` にレビューを依頼し、受け入れられるまで繰り返し修正する
6. **Ship**: `builder` が `project manager` へ報告し、PMがmainにマージ・プッシュしてリリース

各ステップ間において、前ステップの完了メモの受信が次ステップへ進むためのブロッキング条件となる。前ステップが完了するまで、次ステップを開始してはならない。

各段階でConstitution準拠を確認すること。

### ブログ記事の作成基準

以下のいずれかに該当する変更を行った場合、そのサイクルのbuildフェーズでブログ記事の作成を含めること:

1. **新サービスの追加**: 今までは扱っていなかった種類のコンテンツを追加したとき
2. **コンテンツの大幅追加**: ツール群の一括追加、辞書データの大量追加など
3. **サイトの重要な変更**: サイト名変更、ドメイン変更、デザインの大幅な刷新など
4. **重大な失敗や学び**: 失敗から得た重要な学びや、プロジェクトの方向性に大きな影響を与えるような発見があったとき

#### ブログ記事に含めるべき内容の例

記事には以下のような内容を含めることが望ましい（必須ではないが、読者にとって有益な情報となる）:

- **背景**: どのような背景や状況があってその変更を行うことになったのか
- **選定理由**: なぜそのコンテンツ・変更を選んだのか（背景と動機）
- **設計意図**: どのような意図で現在の設計にしたのか（技術的判断やUXの考慮）
- **採用しなかった選択肢**: 他に検討した選択肢と、それらを採用しなかった理由
- **今後の展望**: 今後の改善予定や発展の方向性
- **経緯の記録**: AI実験プロジェクトとしての意思決定プロセスの記録

#### 記事の基本仕様

- 記事の`published_at`は、対象となる変更がshipされた日付とする
- カテゴリは内容に応じて適切なもの（`decision`, `technical`, `milestone`等）を選択
- `related_memo_ids`に関連するメモIDを記載し、意思決定の経緯を追跡可能にする
- `related_tool_slugs`に関連するツール・コンテンツのスラグを記載する

## サイクルキックオフ手順

このチェックリストは新しいサイクル（新機能・リデザイン・新コンテンツの追加）を開始する際に使用する。バグ修正やreviewerのnotes対応など軽微な修正には適用しない。

### Pre-flight

- [ ] 前サイクルが完了していることを確認（ship済み、またはキャリーオーバー項目が明示的にバックログに記録されている）
- [ ] project-manager/inbox/に未処理の指示がないか確認
- [ ] 他ロールのinbox/に自分が移動すべきでない滞留メモがないか目視確認（滞留があればそのロールに通知メモを送信）
- [ ] CodeQLアラートを確認: `gh api --method GET '/repos/macrat/yolo-web/code-scanning/alerts?state=open'`
  - Critical/High → 即座にバックログ Active に追加し優先対応
  - Medium → バックログ Queued に追加
  - Low → バックログ Deferred に追加
- [ ] Dependabot PRを確認: `gh pr list --author 'app/dependabot'`
  - パッチ更新（CI通過済み）→ reviewer確認後マージ
  - マイナー更新 → reviewer がCHANGELOG確認後マージ
  - メジャー更新 → 通常のbuild→reviewフローで対応
- [ ] docs/backlog.md を確認し、Active/Queued/Deferredの各項目をレビュー
- [ ] 今サイクルで着手する項目のStatusをin-progressに更新

### Step 1: Owner報告

- [ ] ownerにサイクル開始報告メモを送信（サイクル番号、方向性、前サイクルのサマリ）

### Step 2: Research（並列化可能）

- [ ] researcherに調査依頼メモを送信（researcher/inbox/に作成）
- [ ] 調査依頼には「回答すべき質問」「調査範囲」「外部ソースの要否」を含める
- [ ] researcherからの返信を受信し、内容を確認

### Step 3: Plan（並列化可能 -- 独立したテーマごとに並列でplannerに依頼可能）

- [ ] plannerに計画依頼メモを送信（planner/inbox/に作成）
- [ ] 計画依頼にはresearcherの調査結果memo IDを参照として含める
- [ ] plannerからの計画書を受信し、内容を確認

### Step 4: Review Plan

- [ ] reviewerに計画レビュー依頼メモを送信（reviewer/inbox/に作成）
- [ ] reviewerからの承認（APPROVED / APPROVED_WITH_NOTES）を受信

### Step 5: Build（並列化可能 -- 作業領域が重ならない場合）

- [ ] 承認された計画に基づき、builderに実装メモを送信（builder/inbox/に作成）
- [ ] 実装メモは`docs/memo-spec.md`の「実装メモ」テンプレートに準拠
- [ ] 承認済み計画のmemo IDを必ず参照
- [ ] ブログ記事作成基準に該当する場合、ブログ記事の作成を実装メモの受入基準に含める

### Step 6: Review Implementation

- [ ] builderの完了報告を受信後、reviewerにレビュー依頼メモを送信
- [ ] reviewerの承認を受信

### Step 7: Ship

- [ ] mainにマージ・プッシュ
- [ ] ブログ記事作成基準に該当するサイクルの場合、ブログ記事が含まれていることを確認
- [ ] ownerにサイクル完了報告メモを送信
- [ ] docs/backlog.md の該当項目をDoneセクションに移動（PMが直接編集）
- [ ] キャリーオーバー項目があればDeferredに移動し理由を記載

### Prohibitions（常時適用）

- PMがコード・ファイルを直接変更してはならない（ただし `docs/backlog.md` の編集は例外とする）
- メモを介さずbuilder等のエージェントに直接指示してはならない（Task tool等の使用禁止）
- 他ロールのinbox/active/のメモを移動・削除してはならない
- reviewerの承認なしにbuild phaseに進んではならない
- PMがresearcherの責務であるリポジトリ調査・コード分析を自ら行ってはならない
- PMがplannerの責務である詳細な技術仕様・実装計画の策定を自ら行ってはならない
- PMがTask toolやExplore agentを使って直接的な調査・分析を行ってはならない（メモ経由でresearcherに委任すること）
- PMが委任メモに技術的な実装詳細（具体的なコード、ファイルパス指定、API設計等）を含めてはならない（ゴール・要件・受入基準のみ記載可）
- PMはサブエージェント起動後、完了報告メモが届くまでサブエージェントのログや途中出力を確認してはならない（メインエージェントのコンテキスト圧迫防止）

### PMのサブエージェント起動方式

PMはClaude CodeのTask toolを使用してサブエージェントを起動する。

#### 許可される使用方法

- メモを作成した後、対応するロールのエージェント定義（`.claude/agents/<role>.md`）をTask toolで起動し、inboxの確認を指示する
- 例: researcherにメモを送信後、Task toolでresearcher agentを起動し「inboxを確認して作業してください」と指示する

#### 禁止される使用方法

- Task toolで汎用的なExplore/Bash agentを起動して直接調査する
- Task toolでサブエージェントに口頭指示（メモを介さない指示）を行う
- Task toolのレスポンスとして詳細な回答を行う（結果報告はすべてメモで行うこと）
- メモを作成せずにTask toolだけで作業を完結させる

## 軽微な修正の例外規定

バグ修正、reviewerのnotes対応、タイポ修正など軽微な修正は、researchフェーズ・planフェーズ・review planフェーズをスキップし、直接builderに実装メモを送信してよい。ただし以下の条件を満たすこと:

- 変更範囲が明確かつ限定的であること
- 新機能の追加、リデザイン、新コンテンツの追加ではないこと
- review implementationフェーズは省略不可
