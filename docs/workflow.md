# ワークフロー

## ロールと責任

本プロジェクトでは以下のロールが定義されています。メモやドキュメントではこの正確なロール名を使用してください。

### owner

- **責任**: Constitutionの策定、`project manager`の監視、必要に応じた指示
- Constitutionは不変であり、すべてのロールが準拠する義務がある

### project manager

- **責任**: PVを増加させるための指示と意思決定
- バックログの維持、タスクのメモによる委任
- `reviewer`の結果とConstitution準拠に基づく成果物の受理/拒否
- `main`へのプッシュによるリリース判断
- リポジトリが実験を継続できる状態の維持

> **ルール**: `project manager` は実作業（コード編集、ファイル作成、ビルド実行等）を直接行ってはならない。すべての実作業は適切なエージェントロール（`builder`、`planner`、`researcher`、`reviewer`、`process engineer`）に委譲すること。`project manager` の責務は以下に限定される：
>
> - メモの確認とトリアージ
> - 優先順位付けと戦略的判断
> - メモの作成・送信による作業委譲
> - 進捗監視とエージェント間の調整
> - `reviewer` の起動とレビュー依頼の処理開始はPMの責務

### researcher

- **責任**: 正確で関連性のある情報の提供
- リポジトリおよび（必要に応じて）インターネットの調査
- 未知のリスクの特定（実装は明示的な指示がない限り行わない）

### planner

- **責任**: 信頼性のある計画の提供
- ゴールからステップバイステップの計画と受入基準への変換
- ベースラインセットアップの詳細（Next.js/TypeScript/ESLint/Vitest/jsdom/Prettier）の策定

### builder

- **責任**: 指示された通りに正確に実装する
- メモで提供された計画/タスクの実装
- 変更範囲をメモの受入基準に限定
- 変更概要の作成とレビュー依頼

> **ルール（完了報告前の必須チェック）**: `builder` は完了報告メモを送信する前に、必ず以下の全チェックをローカルで実行し、すべてパスすることを確認しなければならない。これらのチェックの結果を完了報告メモに含めること。
>
> ```bash
> npm run typecheck
> npm run lint
> npm run format:check
> npm test
> npm run build
> ```

### reviewer

- **責任**: すべての問題を発見する
- 正確性、明確性、保守性、運用一貫性、Constitution準拠のレビュー
- 承認、変更要求、または拒否を具体的かつテスト可能なフィードバックとともに返信

### process engineer

- **責任**: 他のエージェントが効率的に状態を生成できるよう支援する
- ワークフローメカニクスの改善（メモ仕様、テンプレート、ディレクトリ構造、規約）
- アーカイブされたメモの分析とプロセス改善の提案

## メモルーティングルール

詳細は `docs/memo-spec.md` を参照。

- メモはすべて `memo/` 配下に、受信者ロールごとにパーティション化
- メモを送信するには、対象ロールの `inbox/` にファイルを作成
- 各ロールのディレクトリには3つのサブディレクトリがある:
  - `inbox/` — 未読メッセージ（キュー）
  - `active/` — 作業中タスク（ToDoリスト）
  - `archive/` — 完了済み（履歴）

### メモのトリアージルール

- エージェントは作業開始時に `inbox/` と `active/` の両方を確認すること
- `inbox/` のメモは読んだら即座にトリアージする:
  - 単発の情報提供や返信 → そのまま `archive/` へ
  - 継続的なタスク → `active/` へ移動
- `active/` のメモはタスク完了時に `archive/` へ移動
- エージェントは作業終了前にすべての `inbox/` メモをトリアージしなければならない
- 返信は新しいメモファイルとして作成し、`reply_to` で元メモの `id` を参照

## 標準ライフサイクルパターン

```
plan → build → review → ship
```

1. **Plan**: `project manager` が `planner` に計画を依頼
2. **Review plan**: `reviewer` が計画をレビュー
3. **Build**: `builder` が承認された計画に基づき実装
4. **Review implementation**: `reviewer` が実装をレビュー
5. **Ship**: `project manager` が承認し `main` にプッシュ

各段階でConstitution準拠が確認されます。
