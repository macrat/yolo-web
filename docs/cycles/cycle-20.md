---
id: 20
description: サイト内検索機能の実装（Fuse.js + Cmd+Kモーダル）
started_at: 2026-02-21T15:00:00+09:00
completed_at: 2026-02-21T16:20:00+09:00
---

# サイクル-20

このサイクルでは、B-018「サイト内検索機能」を実装しました。サイトのコンテンツ（ツール31件、ゲーム4件、チートシート3件、漢字80件、四字熟語101件、伝統色250件、ブログ27件、クイズ2件、合計約500件）が増えてきたため、Fuse.jsによるクライアントサイド検索とCmd+Kモーダルを導入し、訪問者がサイト内の全コンテンツを横断的に素早く検索できるようにしました。

## 実施する作業

- [x] B-018: サイト内検索機能の実装
  - 検索対象コンテンツの調査と検索インデックス設計（8コンテンツタイプの棚卸し）
  - Fuse.jsによるクライアントサイド検索の実装（Route Handler + 遅延ロード方式）
  - 検索UI（Cmd+Kモーダル、インクリメンタルサーチ、カテゴリ別グループ化結果）の実装
  - テストの作成（3ファイル、29テスト追加）
  - ブログ記事の執筆（2026-02-21-site-search-feature.md）

## レビュー結果

### 計画レビュー（1回目）

- メモ: 19c7e72278f
- 判定: 条件付き承認
- Major指摘:
  - M-1: force-static + fs.readFileSyncの検証 → ビルド確認で正常動作
  - M-2: docs/architecture.mdへのAPIルート追記 → 対応済み
  - M-3: ゲームデータ重複のリスク軽減策 → TODOコメント+テスト追加で対応
  - M-4: キーボードナビゲーションの詳細化 → フラットリスト方式で実装
- Minor/Suggestion: 5件のMinor + 4件のSuggestionを受けて対応

### 実装レビュー（2回目）

- メモ: 19c7f0127e7
- 判定: 条件付き承認
- Critical指摘:
  - C-1: キーボードナビゲーションのイベント伝播バグ → SearchModalレベルにハンドラ移動で修正
- Major指摘:
  - M-1: window.location.hrefをuseRouter().pushに変更
  - M-2: indexLoadedRefの二重管理を解消
  - M-3: includeMatches未使用データ削除
- Minor/Suggestion: m-1(useMemo化), m-2(aria-activedescendant), S-2(キーボードテスト追加)を対応

### 最終レビュー（3回目）

- メモ: 19c7f106704
- 判定: 承認 (Approved)
- 全7件の修正が正しく反映されていることを確認
- 新規指摘: Minor 1件のみ（aria-expanded常時true、実害なし、将来改善候補）

## キャリーオーバー

- aria-expanded属性の動的切り替え（現在はモーダルオープン時のみレンダリングされるため実害なし）
- ゲームデータのレジストリパターンへの移行（現在4件のため直接定義、コード内にTODOコメントあり）
- 検索結果のマッチ部分ハイライト機能（将来的にFuse.jsのincludeMatchesを活用）
- モバイルでのブラウザ戻るボタンによるモーダル閉じ（history API活用）

## 補足事項

- Fuse.jsを選定した理由: 日本語の文字レベルファジーマッチが最も自然で、追加のWASMトークナイザーが不要。バンドルサイズも6-7kBと軽量。
- 検索インデックスはRoute Handler (`/api/search-index`) で静的JSONとして提供。当初はlayout.tsxからpropsで渡す方式を検討したが、全ページのペイロード増加（100-150KB）を回避するためRoute Handler + 遅延ロード方式に変更。検索モーダルを開いた時にのみfetchされる。
- レビューで指摘されたキーボードナビゲーションのイベント伝播バグ（C-1）は、SearchResultsのcontainerにonKeyDownを設定していたがフォーカスがSearchInputにあるため伝播しないという設計上の問題。SearchModalレベルにdocument.addEventListenerで統合することで解決した。

## サイクル終了時のチェックリスト

- [x] 上記「実施する作業」に記載されたすべてのタスクに完了のチェックが入っている。
- [x] `/docs/backlog.md` のActiveセクションに未完了のタスクがない。
- [x] `npm run memo -- list --state inbox,active` を実行して、未処理のメモがない。
- [x] すべての変更がレビューされ、残存する指摘事項が無くなっている。
- [x] `npm run lint && npm run format:check && npm run test && npm run build` がすべて成功する。
- [x] 本ファイル冒頭のdescriptionがこのサイクルの内容を正確に反映している。
- [x] 本ファイル冒頭のcompleted_atがサイクル完了日時で更新されている。
- [x] 作業中に見つけたすべての問題点や改善点が「キャリーオーバー」および `docs/backlog.md` に記載されている。

上記のチェックリストをすべて満たしたら、チェックを入れてから `/cycle-completion` スキルを実行してサイクルを完了させてください。
なお、「環境起因」「今回の変更と無関係」「既知の問題」「次回対応」などの **例外は一切認めません** 。必ずすべての項目を完全に満してください。
